#!/bin/bash
# Task Management CLI - Automates task operations with WIP limits

set -e

TASK_DIR=".tasks"
WIP_LIMIT=5

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

function claim() {
    local task=$1

    if [ -z "$task" ]; then
        echo -e "${RED}âŒ Error: Task name required${NC}"
        echo "Usage: $0 claim <task-name>"
        exit 1
    fi

    # Check WIP limit
    current_wip=$(find $TASK_DIR/in-progress -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
    if [ $current_wip -ge $WIP_LIMIT ]; then
        echo -e "${RED}âŒ WIP limit exceeded ($current_wip/$WIP_LIMIT)${NC}"
        echo "Complete or archive tasks first. Current tasks in progress:"
        find $TASK_DIR/in-progress -name "*.md" -exec basename {} .md \; 2>/dev/null | sed 's/^/  - /'
        exit 1
    fi

    # Check if task exists in todo
    if [ -f "$TASK_DIR/todo/$task.md" ]; then
        git mv "$TASK_DIR/todo/$task.md" "$TASK_DIR/in-progress/$task.md"
    elif [ -d "$TASK_DIR/todo/$task" ]; then
        git mv "$TASK_DIR/todo/$task" "$TASK_DIR/in-progress/$task"
    else
        echo -e "${RED}âŒ Task not found in todo: $task${NC}"
        echo "Available tasks:"
        find $TASK_DIR/todo -name "*.md" -exec basename {} .md \; 2>/dev/null | head -10 | sed 's/^/  - /'
        exit 1
    fi

    # Commit and push
    git commit -m "chore(tasks): claim $task"
    git push origin dev

    new_wip=$((current_wip + 1))
    echo -e "${GREEN}âœ… Claimed task: $task${NC}"
    echo -e "WIP: $new_wip/$WIP_LIMIT"
}

function complete() {
    local task=$1

    if [ -z "$task" ]; then
        echo -e "${RED}âŒ Error: Task name required${NC}"
        echo "Usage: $0 complete <task-name>"
        exit 1
    fi

    # Check if task exists in in-progress
    if [ -f "$TASK_DIR/in-progress/$task.md" ]; then
        mkdir -p "$TASK_DIR/in-review"
        git mv "$TASK_DIR/in-progress/$task.md" "$TASK_DIR/in-review/$task.md"
    elif [ -d "$TASK_DIR/in-progress/$task" ]; then
        mkdir -p "$TASK_DIR/in-review"
        git mv "$TASK_DIR/in-progress/$task" "$TASK_DIR/in-review/$task"
    else
        echo -e "${RED}âŒ Task not found in progress: $task${NC}"
        echo "Current in-progress tasks:"
        find $TASK_DIR/in-progress -name "*.md" -exec basename {} .md \; 2>/dev/null | sed 's/^/  - /'
        exit 1
    fi

    # Commit and push
    git commit -m "chore(tasks): complete $task - moved to review"
    git push origin dev

    current_wip=$(find $TASK_DIR/in-progress -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
    echo -e "${GREEN}âœ… Implementation completed: $task (moved to review)${NC}"
    echo -e "WIP: $current_wip/$WIP_LIMIT"
}

function health() {
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘         ğŸ“Š TASK HEALTH REPORT          â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    # Count tasks in each state
    todo_count=$(find $TASK_DIR/todo -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
    wip_count=$(find $TASK_DIR/in-progress -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
    review_count=$(find $TASK_DIR/in-review -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
    done_count=$(find $TASK_DIR/done -name "*.md" 2>/dev/null | wc -l | tr -d ' ')

    echo "ğŸ“‹ TODO:        $todo_count tasks"

    # Color code WIP based on limit
    if [ $wip_count -gt $WIP_LIMIT ]; then
        echo -e "ğŸš€ IN PROGRESS: ${RED}$wip_count tasks (âš ï¸ OVER LIMIT - target: 2-5)${NC}"
    elif [ $wip_count -eq 0 ]; then
        echo -e "ğŸš€ IN PROGRESS: ${YELLOW}$wip_count tasks (ğŸ’¤ No active work)${NC}"
    else
        echo -e "ğŸš€ IN PROGRESS: ${GREEN}$wip_count tasks (target: 2-5)${NC}"
    fi

    echo "ğŸ” IN REVIEW:   $review_count tasks"
    echo "âœ… DONE:        $done_count tasks (approved, ready for merge to main)"
    echo ""

    # Find stale tasks (older than 30 hours for agentic workflows)
    if [ $wip_count -gt 0 ]; then
        # Using 2 days as proxy for 30+ hours in find command
        stale_tasks=$(find $TASK_DIR/in-progress -name "*.md" -mtime +1 2>/dev/null)
        if [ ! -z "$stale_tasks" ]; then
            stale_count=$(echo "$stale_tasks" | wc -l | tr -d ' ')
            echo -e "${YELLOW}âš ï¸  STALE TASKS (>30 hours in progress): $stale_count${NC}"
            echo "$stale_tasks" | xargs -I {} basename {} .md | head -5 | sed 's/^/    â€¢ /'
            echo ""
        fi
    fi

    # Check WIP limit
    if [ $wip_count -gt $WIP_LIMIT ]; then
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${RED}ğŸ”´ ACTION REQUIRED: WIP LIMIT EXCEEDED${NC}"
        echo -e "${RED}   Current: $wip_count | Maximum: $WIP_LIMIT${NC}"
        echo -e "${RED}   Archive or complete tasks before claiming new ones.${NC}"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    fi

    # Show review backlog warning
    if [ $done_count -gt 10 ]; then
        echo -e "${YELLOW}âš ï¸  REVIEW BACKLOG: $done_count tasks awaiting review${NC}"
    fi
}

function list() {
    local status=${1:-"all"}

    case $status in
        "todo")
            echo -e "${GREEN}=== TODO Tasks ===${NC}"
            find $TASK_DIR/todo -name "*.md" -exec basename {} .md \; 2>/dev/null | sort | sed 's/^/  â€¢ /'
            ;;
        "wip"|"in-progress")
            echo -e "${YELLOW}=== In Progress Tasks ===${NC}"
            find $TASK_DIR/in-progress -name "*.md" 2>/dev/null | while read file; do
                task=$(basename "$file" .md)
                hours_old=$(( ($(date +%s) - $(stat -f %m "$file" 2>/dev/null || stat -c %Y "$file" 2>/dev/null)) / 3600 ))
                if [ $hours_old -gt 30 ]; then
                    echo -e "  â€¢ ${RED}$task (${hours_old} hours old - STALE)${NC}"
                elif [ $hours_old -gt 15 ]; then
                    echo -e "  â€¢ ${YELLOW}$task (${hours_old} hours old - WARNING)${NC}"
                else
                    echo -e "  â€¢ $task (${hours_old} hours old)"
                fi
            done
            ;;
        "review"|"in-review")
            echo -e "${YELLOW}=== Tasks In Review ===${NC}"
            find $TASK_DIR/in-review -name "*.md" -exec basename {} .md \; 2>/dev/null | sort | sed 's/^/  â€¢ /'
            ;;
        "done")
            echo -e "${GREEN}=== Done Tasks (Approved, Ready for Merge to Main) ===${NC}"
            find $TASK_DIR/done -name "*.md" -exec basename {} .md \; 2>/dev/null | sort | sed 's/^/  â€¢ /'
            ;;
        *)
            health
            ;;
    esac
}

function archive() {
    local task=$1
    local reason=${2:-"stale"}

    if [ -z "$task" ]; then
        echo -e "${RED}âŒ Error: Task name required${NC}"
        echo "Usage: $0 archive <task-name> [reason]"
        exit 1
    fi

    # Create backlog dir if needed
    mkdir -p $TASK_DIR/backlog

    # Find and move task from any state
    task_found=false
    for dir in in-progress todo in-review done; do
        if [ -f "$TASK_DIR/$dir/$task.md" ]; then
            git mv "$TASK_DIR/$dir/$task.md" "$TASK_DIR/backlog/$task.md"
            task_found=true
            from_dir=$dir
            break
        elif [ -d "$TASK_DIR/$dir/$task" ]; then
            git mv "$TASK_DIR/$dir/$task" "$TASK_DIR/backlog/$task"
            task_found=true
            from_dir=$dir
            break
        fi
    done

    if [ "$task_found" = false ]; then
        echo -e "${RED}âŒ Task not found: $task${NC}"
        exit 1
    fi

    git commit -m "chore(tasks): archive $task from $from_dir - reason: $reason"
    git push origin dev

    echo -e "${GREEN}âœ… Archived task: $task${NC}"
    echo -e "   From: $from_dir â†’ backlog"
    echo -e "   Reason: $reason"
}

function approve() {
    local task=$1

    if [ -z "$task" ]; then
        echo -e "${RED}âŒ Error: Task name required${NC}"
        echo "Usage: $0 approve <task-name>"
        exit 1
    fi

    # Move from in-review to done (approved and ready for merge to main)
    if [ -f "$TASK_DIR/in-review/$task.md" ]; then
        mkdir -p "$TASK_DIR/done"
        git mv "$TASK_DIR/in-review/$task.md" "$TASK_DIR/done/$task.md"
    elif [ -d "$TASK_DIR/in-review/$task" ]; then
        mkdir -p "$TASK_DIR/done"
        git mv "$TASK_DIR/in-review/$task" "$TASK_DIR/done/$task"
    else
        echo -e "${RED}âŒ Task not found in review: $task${NC}"
        echo "Available tasks in review:"
        find $TASK_DIR/in-review -name "*.md" -exec basename {} .md \; 2>/dev/null | head -10 | sed 's/^/  - /'
        exit 1
    fi

    git commit -m "chore(tasks): approve $task - ready for merge to main"
    git push origin dev

    echo -e "${GREEN}âœ… Review approved: $task (ready for merge to main)${NC}"
}

function help() {
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘         ğŸ“‹ TASK MANAGEMENT CLI         â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "Usage: $0 <command> [arguments]"
    echo ""
    echo "Workflow: todo â†’ in-progress â†’ in-review â†’ done â†’ main"
    echo ""
    echo "Commands:"
    echo "  claim <task>      - Claim a task from todo (enforces WIP limit)"
    echo "  complete <task>   - Complete implementation, move to review"
    echo "  approve <task>    - Approve reviewed task (ready for merge to main)"
    echo "  archive <task>    - Archive task to backlog (with reason)"
    echo "  health            - Show comprehensive task health report"
    echo "  list [status]     - List tasks by status:"
    echo "                      â€¢ todo     - Available tasks"
    echo "                      â€¢ wip      - In-progress tasks"
    echo "                      â€¢ review   - Tasks in review"
    echo "                      â€¢ done     - Approved, ready for merge"
    echo "                      â€¢ all      - Full health report (default)"
    echo ""
    echo "Examples:"
    echo "  $0 claim feature-auth"
    echo "  $0 complete feature-auth     # Implementer: done coding"
    echo "  $0 approve feature-auth      # Reviewer: approved after review"
    echo "  $0 health"
    echo "  $0 list wip"
    echo "  $0 archive old-task \"deprioritized\""
    echo ""
    echo "WIP Limit: $WIP_LIMIT tasks maximum in progress"
}

# Main command dispatcher
case "$1" in
    "claim")
        claim "$2"
        ;;
    "complete")
        complete "$2"
        ;;
    "approve")
        approve "$2"
        ;;
    "archive")
        archive "$2" "$3"
        ;;
    "health"|"status")
        health
        ;;
    "list"|"ls")
        list "$2"
        ;;
    "help"|"--help"|"-h")
        help
        ;;
    *)
        if [ -z "$1" ]; then
            health
        else
            echo -e "${RED}Unknown command: $1${NC}"
            echo ""
            help
            exit 1
        fi
        ;;
esac
