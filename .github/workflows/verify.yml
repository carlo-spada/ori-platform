# .github/workflows/verify.yml

name: Verification Ritual

# Run this workflow on every pull request targeting the main branch
on:
  pull_request:
    branches: [main]

jobs:
  # This job is named 'verify'
  verify:
    runs-on: ubuntu-latest

    steps:
      # 1. Get the code from the PR
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      # 3. Set up the environment (e.g., Node.js)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18' # Adjusted to project's Node.js 18+ requirement
          cache: 'pnpm' # Changed to pnpm cache

      # 4. Install dependencies
      - name: Install dependencies
        run: pnpm install

      # 5. Setup Python for AI Engine tests
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'services/ai-engine/requirements.txt'

      # 6. Install Python dependencies for AI Engine
      - name: Install AI Engine dependencies
        run: |
          cd services/ai-engine
          pip install -r requirements.txt

      # 7. Code Quality Checks
      - name: Check Formatting
        run: pnpm format:check

      - name: Run Linter
        run: pnpm lint

      # 8. Run Tests
      - name: Run Frontend Tests (Vitest)
        run: pnpm test -- --run

      - name: Run Core API Tests (Jest)
        run: pnpm --filter @ori/core-api test

      - name: Run AI Engine Tests (pytest)
        run: |
          cd services/ai-engine
          python -m pytest tests/ -v

      # 9. Build Check
      - name: Build Frontend
        run: pnpm build

      - name: Build Core API
        run: pnpm --filter @ori/core-api build
