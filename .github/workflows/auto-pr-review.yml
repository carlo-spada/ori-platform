name: 'Auto PR Review & Merge'

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

concurrency:
  group: 'auto-review-${{ github.event.pull_request.number }}'
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: read

jobs:
  # Job 1: Run verification checks
  verify:
    name: 'Verify PR'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      verification_passed: ${{ steps.check_results.outputs.passed }}

    steps:
      - name: 'Checkout PR branch'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: 'Setup pnpm'
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: 'Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: 'Install dependencies'
        run: pnpm install --frozen-lockfile
        continue-on-error: false

      - name: 'Run linter'
        id: lint
        run: pnpm lint
        continue-on-error: true

      - name: 'Run build'
        id: build
        run: pnpm build
        continue-on-error: true

      - name: 'Run tests'
        id: test
        run: pnpm test || echo "No tests configured"
        continue-on-error: true

      - name: 'Check verification results'
        id: check_results
        run: |
          LINT_STATUS="${{ steps.lint.outcome }}"
          BUILD_STATUS="${{ steps.build.outcome }}"

          if [ "$LINT_STATUS" = "success" ] && [ "$BUILD_STATUS" = "success" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ All verification checks passed"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "‚ùå Verification checks failed"
            echo "- Lint: $LINT_STATUS"
            echo "- Build: $BUILD_STATUS"
            exit 1
          fi

  # Job 2: Automated code review
  review:
    name: 'Automated Review'
    needs: verify
    if: needs.verify.outputs.verification_passed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      review_approved: ${{ steps.review_decision.outputs.approved }}
      review_comment: ${{ steps.review_decision.outputs.comment }}

    steps:
      - name: 'Checkout PR branch'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: 'Fetch base branch'
        run: |
          git fetch origin main:main

      - name: 'Analyze PR changes'
        id: analyze
        run: |
          echo "Analyzing PR #${{ github.event.pull_request.number }}"

          # Get changed files
          CHANGED_FILES=$(git diff --name-only main...HEAD)
          FILE_COUNT=$(echo "$CHANGED_FILES" | grep -c '^' || echo 0)

          # Get stats
          ADDITIONS=$(git diff --shortstat main...HEAD | grep -oP '\d+(?= insertion)' || echo "0")
          DELETIONS=$(git diff --shortstat main...HEAD | grep -oP '\d+(?= deletion)' || echo "0")

          echo "changed_files=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "additions=${ADDITIONS:-0}" >> $GITHUB_OUTPUT
          echo "deletions=${DELETIONS:-0}" >> $GITHUB_OUTPUT

          # Check for risky patterns
          RISKY=false

          # Check for package.json changes without lockfile
          if echo "$CHANGED_FILES" | grep -q "package.json" && ! echo "$CHANGED_FILES" | grep -q "pnpm-lock.yaml"; then
            echo "‚ö†Ô∏è package.json changed without pnpm-lock.yaml"
            RISKY=true
          fi

          # Check for large PRs (over 500 lines changed)
          TOTAL_CHANGES=$((${ADDITIONS:-0} + ${DELETIONS:-0}))
          if [ $TOTAL_CHANGES -gt 500 ]; then
            echo "‚ö†Ô∏è Large PR detected: $TOTAL_CHANGES lines changed"
            RISKY=true
          fi

          # Check for direct modification of critical files
          if echo "$CHANGED_FILES" | grep -qE "(\.github/workflows/|AGENTS\.md|package\.json)"; then
            echo "‚ö†Ô∏è Critical files modified"
            RISKY=true
          fi

          echo "risky=$RISKY" >> $GITHUB_OUTPUT

      - name: 'Make review decision'
        id: review_decision
        run: |
          RISKY="${{ steps.analyze.outputs.risky }}"
          FILE_COUNT="${{ steps.analyze.outputs.changed_files }}"
          ADDITIONS="${{ steps.analyze.outputs.additions }}"
          DELETIONS="${{ steps.analyze.outputs.deletions }}"

          # Generate review comment
          COMMENT="## ü§ñ Automated Review Summary

          **PR Statistics:**
          - Files changed: $FILE_COUNT
          - Lines added: $ADDITIONS
          - Lines deleted: $DELETIONS

          **Verification Checks:** ‚úÖ Passed
          - Linting: ‚úÖ
          - Build: ‚úÖ

          "

          if [ "$RISKY" = "true" ]; then
            COMMENT="${COMMENT}**Review Status:** ‚ö†Ô∏è Manual review recommended
            
            This PR modifies critical files or makes significant changes. A human reviewer should verify the changes before merging.
            
            To merge manually:
            1. Review the changes carefully
            2. Approve the PR
            3. The auto-merge will proceed after approval"
            
            echo "approved=false" >> $GITHUB_OUTPUT
          else
            COMMENT="${COMMENT}**Review Status:** ‚úÖ Auto-approved
            
            This PR passed all automated checks and doesn't modify critical files. It will be automatically merged."
            
            echo "approved=true" >> $GITHUB_OUTPUT
          fi

          # Save comment to file for multi-line output
          echo "$COMMENT" > /tmp/review_comment.txt
          echo "comment<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/review_comment.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 'Post review comment'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `${{ steps.review_decision.outputs.comment }}`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Job 3: Auto-merge if approved
  auto-merge:
    name: 'Auto-merge PR'
    needs: [verify, review]
    if: needs.review.outputs.review_approved == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: 'Approve PR'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                event: 'APPROVE',
                body: '‚úÖ Automatically approved by auto-review system after passing all checks.'
              });
              console.log('PR approved successfully');
            } catch (error) {
              // Ignore if already approved
              console.log('Approval status:', error.message);
            }

      - name: 'Merge PR'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const result = await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                merge_method: 'squash',
                commit_title: '${{ github.event.pull_request.title }}',
                commit_message: 'Automatically merged by auto-review system after passing all automated checks.'
              });
              
              if (result.data.merged) {
                console.log('‚úÖ PR merged successfully');
                
                // Post success comment
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: 'üéâ **Automatically merged!** All checks passed and no manual review was required.'
                });
              }
            } catch (error) {
              console.error('Failed to merge PR:', error.message);
              
              // Post failure comment
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `‚ùå **Auto-merge failed:** ${error.message}\n\nPlease merge manually.`
              });
              
              throw error;
            }

  # Job 4: Handle verification failures
  handle-failure:
    name: 'Handle Failures'
    needs: verify
    if: needs.verify.outputs.verification_passed == 'false'
    runs-on: ubuntu-latest

    steps:
      - name: 'Post failure comment'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ùå Automated Review Failed

              This PR did not pass the automated verification checks.

              **Required fixes:**
              - Ensure \`pnpm lint\` passes without errors
              - Ensure \`pnpm build\` completes successfully
              - Fix any failing tests

              Please push fixes to this PR branch. The automated review will run again automatically.`
            });
