name: Automated Translations

on:
  push:
    branches:
      - main
      - dev
    paths:
      - 'public/locales/en/**/*.json'
      - 'src/app/legal/**/*.tsx'
  workflow_dispatch:
    inputs:
      namespace:
        description: 'Specific namespace to translate (leave empty for all)'
        required: false
        type: string
      language:
        description: 'Specific language to translate to (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - 'de'
          - 'es'
          - 'fr'
          - 'it'

jobs:
  translate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Translation Script
        env:
          DEEPL_API_KEY: ${{ secrets.DEEPL_API_KEY }}
        run: |
          # Use the simpler sync script for reliability
          pnpm exec tsx scripts/sync-translations.ts

      - name: Check for Changes
        id: changes
        run: |
          git diff --exit-code || echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Commit and Push Translations
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'

          git add public/locales/
          git commit -m "chore(i18n): update translations via DeepL API

          Co-authored-by: DeepL <noreply@deepl.com>"

          git push

      - name: Create Pull Request (if on dev branch)
        if: steps.changes.outputs.has_changes == 'true' && github.ref == 'refs/heads/dev'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: translations-update
          title: 'chore(i18n): Update Translations'
          body: |
            ## Translation Updates

            This PR contains automated translation updates from DeepL.

            ### Changes
            - Updated translation files for multiple languages
            - Ensured consistency across all namespaces

            ### Languages Updated
            - ðŸ‡©ðŸ‡ª German (de)
            - ðŸ‡ªðŸ‡¸ Spanish (es)
            - ðŸ‡«ðŸ‡· French (fr)
            - ðŸ‡®ðŸ‡¹ Italian (it)

            ### Review Checklist
            - [ ] Translations are contextually appropriate
            - [ ] No untranslated placeholders remain
            - [ ] Special terms (Ori, etc.) are preserved

            ---
            *Generated automatically by DeepL Translation workflow*